I have refined the plan to prioritize the UI/UX bugs you reported, followed by the comprehensive optimization suite.

### **Phase 1: Critical UI/UX Fixes (Immediate Priority)**
1.  **Smart Selection Toggle**:
    *   **Action**: In `VMList.tsx`, remove the separate "Select All" and "None" buttons.
    *   **New UI**: Implement a single **Toggle Button** in the header (next to "VMs").
    *   **Logic**:
        *   If all VMs are selected → Button shows "Unselect All" (Square icon).
        *   If some or no VMs are selected → Button shows "Select All" (CheckSquare icon).
        *   This directly addresses your request for a single, context-aware button.
2.  **Run Button Visibility Fix**:
    *   **Action**: In `CommandExecutor.tsx`, I will safeguard the "Run" button layout.
    *   **Fix**: Ensure long text (e.g., "Run on 150 VMs") doesn't push the button out of view. I will implement text truncation or a compact badge style (e.g., "Run (150)") to keep the UI stable regardless of selection size.

### **Phase 2: Frontend Core Optimizations**
3.  **Memory Management**: Implement an **LRU Eviction Policy** in `vmStore` to clean up old cache entries and prevent memory leaks.
4.  **Network Stability**: Add **AbortController** to `fetchVMs` to cancel stale requests when switching environments rapidly.
5.  **Socket Architecture**: Extract WebSocket logic from `CommandExecutor` into a robust **`useSocket` hook** to prevent unnecessary reconnections.
6.  **Selector Performance**: Split `useVMStore` selectors in `VMList` to prevent the list from re-rendering when execution logs update.

### **Phase 3: Component & Rendering Performance**
7.  **List Virtualization Prep**: Memoize `VMListItem` components so only the specific VM being selected re-renders, not the whole list.
8.  **Handler Stability**: Wrap all inline functions in `VMList` and `CommandExecutor` with `useCallback`.
9.  **Infinite Scroll Hook**: Extract the observer logic into a clean `useInfiniteScroll` hook.

### **Phase 4: Backend Robustness**
10. **Configurable Workers**: Update `executionWorker.ts` to respect a `CONCURRENCY` env var.
11. **Production Logging**: Update `logger.ts` to support log rotation and cleaner production formats.
12. **SSH Safety**: Enhance the password escaping logic in `sshService.ts`.

I will start with **Phase 1** to immediately resolve the UI issues you are facing.